// CourseSmartLocalStorage.js
(function($){
Type.registerNamespace('CourseSmartLocalStorage');CourseSmartLocalStorage.CLocal$2=function(callback){CourseSmartLocalStorage.CLocal$2.initializeBase(this,['SyncModal',CourseSmartLocalStorage.CLocal$2.$1_1()]);this.$1_0=callback;this.add_onLoad(ss.Delegate.create(this,this.$1_2));}
CourseSmartLocalStorage.CLocal$2.$1_1=function(){var $0=new BvD.LayerConfig();$0.width=350;$0.destroyOnClose=true;$0.modalProperties=new BvD.ModalProperties('#012042',0.8,null,BvD.ZIndex.modal);$0.staticId='SyncModalLayer';return $0;}
CourseSmartLocalStorage.CLocal$2.prototype={$1_0:null,$1_2:function($p0,$p1){$('.bow_layer_container #syncdlg-yes').on('click',ss.Delegate.create(this,this.$1_3));},$1_3:function($p0){$p0.preventDefault();this.$1_0();this.close();}}
CourseSmartLocalStorage.Synchronization=function(){}
CourseSmartLocalStorage.Synchronization.init=function(forceSend){if(!BvD.Xsl.get_isLogged()){return;}if(BvD.Xsl.get_offlineVersion()>0||BvD.Xsl.get_currentPage()==='/offlinebookshelf'){return;}if($('#IsHTML5SupportedBrowser').val()!=='true'){return;}var $0=false;var $1=false;if(String.isNullOrEmpty(CourseSmartLocalStorage.OfflineCache.get_currentUser().get_deviceGuid())&&!BvD.Is.NullOrUndefined(window.localStorage)){CourseSmartLocalStorage.Synchronization.$2();$0=true;}var $2=$('#OfflineIsFromLogin');var $3=$2.length>0&&$2.val()==='1';if(!$3&&!forceSend){return;}if(!$0){CourseSmartLocalStorage.Synchronization.$2();}var $4=$('#OfflineLastNoteHighlightModificationDate').val();if(!String.isNullOrEmpty($4)){try{var $6=BvD.ServerDateTime.parse($4);if(!String.isNullOrEmpty(CourseSmartLocalStorage.OfflineCache.get_currentUser().get_lastSyncDate())){var $7=BvD.ServerDateTime.parse(CourseSmartLocalStorage.OfflineCache.get_currentUser().get_lastSyncDate());if($6>$7){$1=true;}}}catch($8){}}var $5=CourseSmartLocalStorage.Synchronization.$1();if($5==null&&!$1){return;}if(forceSend){CourseSmartLocalStorage.Synchronization.$0($5,$1);}else{new CourseSmartLocalStorage.CLocal$2(function(){
CourseSmartLocalStorage.Synchronization.$0($5,$1);}).show();}}
CourseSmartLocalStorage.Synchronization.$0=function($p0,$p1){if($p0!=null){var $0={};$0.async=false;$0.type='POST';$0.data=$p0.toString();$0.success=function($p1_0,$p1_1,$p1_2){
CourseSmartLocalStorage.Synchronization.$3($p1_0,$p1);};$.ajax('/offlinesyncdatas',$0);}else if(CourseSmartLocalStorage.OfflineCache.get_currentUser().hasOfflineBooks()){CourseSmartLocalStorage.OfflineDownloader.$5(null,null);}}
CourseSmartLocalStorage.Synchronization.$1=function(){var $0={};var $1={};var $2=CourseSmartLocalStorage.OfflineCache.get_currentUser().oldDeletedNotes;var $3={};$1['general']=CourseSmartLocalStorage.OfflineCache.get_currentUser().get_preferences();var $dict1=CourseSmartLocalStorage.OfflineCache.get_currentUser().get_$0();for(var $key2 in $dict1){var $5={key:$key2,value:$dict1[$key2]};$2.addRange($5.value.get_notes());if(Object.getKeyCount($5.value.get_hits())>0){$0[$5.key]=$5.value.get_hits();}if(Object.getKeyCount($5.value.get_bookmarks())>0){$3[$5.key]=$5.value.get_bookmarks();}if(!BvD.Is.NullOrUndefined($5.value.get_preference())){$1[$5.key]=$5.value.get_preference();}}if(!Object.getKeyCount($3)&&!$2.length&&!Object.getKeyCount($0)){return null;}var $4=new BvD.QueryString().set('guids',CourseSmartLocalStorage.OfflineCache.get_currentUser().getAllGuids()).set('syncofflinehits',JSON.stringify($0)).set('syncofflinenotes',JSON.stringify($2)).set('syncbookmarks',JSON.stringify($3)).set('syncprefs',JSON.stringify($1));return $4;}
CourseSmartLocalStorage.Synchronization.$2=function(){var $0={};$0.async=false;$0.type='POST';$0.data='guids='+encodeURIComponent(CourseSmartLocalStorage.OfflineCache.get_currentUser().getAllGuids());$0.success=function($p1_0,$p1_1,$p1_2){
try{var $1_0=$p1_0;if(!String.isNullOrEmpty($1_0)&&!$1_0.indexOf('[')){$1_0=BvD.JsonUtils.decompress($1_0);$.parseJSON(BvD.JsonUtils.decompress($1_0));CourseSmartLocalStorage.OfflineCache.get_currentUser().$3($1_0);CourseSmartLocalStorage.CLocal$1.$5();}}catch($1_1){}};$.ajax('/offlinesyncguids',$0);}
CourseSmartLocalStorage.Synchronization.$3=function($p0,$p1){var $0=$.parseJSON(BvD.JsonUtils.decompress($p0));var $1=$0['hits']===1;var $2=$0['notes']===1;var $3=$0['bookmarks']===1;var $4=$0['preferences']===1;var $dict1=CourseSmartLocalStorage.OfflineCache.get_currentUser().get_$0();for(var $key2 in $dict1){var $5={key:$key2,value:$dict1[$key2]};if($1){Object.clearKeys($5.value.get_hits());}if($2){$5.value.get_notes().clear();}if($3){Object.clearKeys($5.value.get_bookmarks());}if($4){$5.value.set_preference(null);}}CourseSmartLocalStorage.CLocal$1.$5();if(($p1||$2||$1||$3||$4)&&CourseSmartLocalStorage.OfflineCache.get_currentUser().hasOfflineBooks()){CourseSmartLocalStorage.OfflineDownloader.$5(null,null);}}
CourseSmartLocalStorage.OfflineDownloader=function(){}
CourseSmartLocalStorage.OfflineDownloader.init=function(){CourseSmartLocalStorage.OfflineDownloader.$1=0;CourseSmartLocalStorage.OfflineDownloader.$3=$('#displaycounter').val()==='1';CourseSmartLocalStorage.CLocal$0.$6(CourseSmartLocalStorage.OfflineDownloader.$6);$(window).on('unload',function($p1_0){
CourseSmartLocalStorage.OfflineDownloader.$D(false);});$(window).on('beforeunload',function($p1_0){
CourseSmartLocalStorage.OfflineDownloader.$D(false);});}
CourseSmartLocalStorage.OfflineDownloader.$5=function($p0,$p1){var $0=CourseSmartLocalStorage.OfflineCache.get_currentUser().getAllGuids();if(String.isNullOrEmpty($0)){return;}var $1=new BvD.QueryString().set('func','sync').set('offlinerandom',Math.floor(Math.random()*100).toString()).set('guids',$0).set('flashsupported',(BvD.Flash.detectVersion(10,0,0))?'1':'0').set('__checkoutmode',(ss.isValue($p1)&&$p1)?'html':'pf');if(ss.isValue($p0)){$1.set('availableinflash',($p0)?'1':'0');}BvD.Cookies.setStateValueParameter('skipdownloadcache','0');window.open('/downloadcache?'+$1.toString(),'DownloadCache','toolbar=no,directories=no,menubar=no,status=no,location=no,scrollbars=yes,copyhistory=no,resizable=yes,height=220,width=500');}
CourseSmartLocalStorage.OfflineDownloader.$6=function($p0){if(BvD.Timer.exists('offline_progress')){BvD.Timer.setTimeout('offline_progress',1000,function(){
CourseSmartLocalStorage.OfflineDownloader.$F();});}if(CourseSmartLocalStorage.OfflineDownloader.$4){return;}if($p0.type==='progress'){CourseSmartLocalStorage.OfflineDownloader.$1++;CourseSmartLocalStorage.OfflineDownloader.$7();}else if($p0.type==='error'){CourseSmartLocalStorage.OfflineDownloader.$D(true);BvD.ClientSideError.send('OfflineDownloader.Error',null);CourseSmartLocalStorage.OfflineDownloader.$10();}else if($p0.type==='noupdate'){var $0=BvD.MathUtils.parseInt32($('#countentries').val(),0);if(CourseSmartLocalStorage.OfflineDownloader.$1<$0){CourseSmartLocalStorage.OfflineDownloader.$1=$0;CourseSmartLocalStorage.OfflineDownloader.$7();}}}
CourseSmartLocalStorage.OfflineDownloader.$7=function(){var $0=BvD.MathUtils.parseInt32($('#countentries').val(),0);if(CourseSmartLocalStorage.OfflineDownloader.$1===$0){CourseSmartLocalStorage.OfflineDownloader.$B();}if(CourseSmartLocalStorage.OfflineDownloader.$1>=$0){return true;}var $1=((CourseSmartLocalStorage.OfflineDownloader.$1/$0)*100).toFixed(1);if(CourseSmartLocalStorage.OfflineDownloader.$3){$('#innertext').html($0+'/'+CourseSmartLocalStorage.OfflineDownloader.$1);}var $2=$('#progressbar');if($2.length>0){$2.attr('aria-valuenow',$1);}$('#progresstext').html($1+'%');$2.css('width',$1+'%');return false;}
CourseSmartLocalStorage.OfflineDownloader.get_$8=function(){return $('#sync').val()==='1';}
CourseSmartLocalStorage.OfflineDownloader.get_$9=function(){return $('#checkin').val()==='1';}
CourseSmartLocalStorage.OfflineDownloader.get_$A=function(){return $('#ischeckout').val()==='1';}
CourseSmartLocalStorage.OfflineDownloader.$B=function(){try{CourseSmartLocalStorage.OfflineDownloader.$4=true;var $0=$('#offlineguids');if($0.length>0){CourseSmartLocalStorage.OfflineCache.get_currentUser().$3($0.val());}var $1=$('#offlineversions');if($1.length>0){CourseSmartLocalStorage.OfflineCache.get_currentUser().$5($1.val());}var $2=$('#offlineemail');if($2.length>0){CourseSmartLocalStorage.OfflineCache.get_currentUser().set_email($2.val());}var $3=$('#offlineswapdates');if($3.length>0){CourseSmartLocalStorage.OfflineCache.get_currentUser().$4($3.val());}if(CourseSmartLocalStorage.OfflineDownloader.get_$8()){CourseSmartLocalStorage.OfflineDownloader.$E();}else if(CourseSmartLocalStorage.OfflineDownloader.get_$A()){CourseSmartLocalStorage.OfflineDownloader.$C();}else{CourseSmartLocalStorage.OfflineDownloader.$F();try{window.opener.location.href='/bookshelf';}catch($4){}}CourseSmartLocalStorage.CLocal$1.$5();}catch($5){}}
CourseSmartLocalStorage.OfflineDownloader.$C=function(){var $0=$('#selectedxmlid').val();CourseSmartLocalStorage.OfflineCache.get_currentUser().get_$0()[$0].set_version(1);if(!String.isNullOrEmpty($0)){var $1=CourseSmartLocalStorage.OfflineCache.get_currentUser().getAllGuids();var $2={xmlid:$0,guids:$1};$.post('/offlinecheckout',$2).complete(function($p1_0,$p1_1){
var $1_0=($p1_0.status===200)?$p1_0.responseText:null;if(String.isNullOrEmpty($1_0)){CourseSmartLocalStorage.OfflineDownloader.$10();}else{CourseSmartLocalStorage.OfflineDownloader.$2=$0;BvD.Timer.setTimeout('offline_progress',1000,function(){
CourseSmartLocalStorage.OfflineDownloader.$F();});BvD.Cookies.setStateValueParameter('usercheckedoutid',BvD.Xsl.get_userId().toString());}});}}
CourseSmartLocalStorage.OfflineDownloader.$D=function($p0){if(CourseSmartLocalStorage.OfflineDownloader.$0||!CourseSmartLocalStorage.OfflineDownloader.get_$A()){return;}var $0=BvD.MathUtils.parseInt32($('#countentries').val(),0);if(CourseSmartLocalStorage.OfflineDownloader.$1>=$0){return;}var $1=$('#selectedxmlid').val();if(!String.isNullOrEmpty($1)){CourseSmartLocalStorage.OfflineDownloader.$0=true;var $2=$('#offlineguids');var $3=CourseSmartLocalStorage.OfflineCache.get_currentUser().$2($2.val());var $4={xmlid:$1,guids:$3};var $5={};$5.url='/offlinecheckoutfailed';$5.async=$p0;$5.data=$4;$.ajax($5);}}
CourseSmartLocalStorage.OfflineDownloader.$E=function(){CourseSmartLocalStorage.OfflineCache.get_currentUser().$1();var $0={guids:CourseSmartLocalStorage.OfflineCache.get_currentUser().getAllGuids()};$.post('/offlinesynched',$0).complete(function($p1_0,$p1_1){
var $1_0=($p1_0.status===200)?$p1_0.responseText:null;if(String.isNullOrEmpty($1_0)){CourseSmartLocalStorage.OfflineDownloader.$10();}else{window.close();}});}
CourseSmartLocalStorage.OfflineDownloader.$F=function(){$('#downloaderror, #progress1').css('display','none');$('#progress2').css('display','block');if(!String.isNullOrEmpty(CourseSmartLocalStorage.OfflineDownloader.$2)){try{window.opener.location.href='/offlinecenter?xmlid='+encodeURIComponent(CourseSmartLocalStorage.OfflineDownloader.$2);}catch($0){}}}
CourseSmartLocalStorage.OfflineDownloader.$10=function(){$('#downloaderror').css('display','block');$('#progress1, #progress2').css('display','none');}
CourseSmartLocalStorage.Html5=function(){}
CourseSmartLocalStorage.Html5.$3=function(){try{CourseSmartLocalStorage.Html5.$B(true);$(window).on('online offline',CourseSmartLocalStorage.Html5.$C);CourseSmartLocalStorage.CLocal$0.$5();}catch($0){}}
CourseSmartLocalStorage.Html5.get_$4=function(){return BvD.MathUtils.parseInt32(BvD.LocalStorage.get('html5version'),-1);}
CourseSmartLocalStorage.Html5.$5=function(){$.get('/isonline?random='+Math.random().toString(),function($p1_0){
var $1_0=CourseSmartLocalStorage.Html5.$0;var $1_1=$p1_0;try{if($1_1.startsWith('Y')){CourseSmartLocalStorage.Html5.$0=true;var $1_2=BvD.MathUtils.parseInt32($1_1.substring(0,2),0);if(CourseSmartLocalStorage.Html5.$8($1_2)){CourseSmartLocalStorage.Html5.$9();}}else{CourseSmartLocalStorage.Html5.$0=false;}}catch($1_3){CourseSmartLocalStorage.Html5.$0=false;}if($1_0!==CourseSmartLocalStorage.Html5.$0){CourseSmartLocalStorage.Html5.$B(false);}});}
CourseSmartLocalStorage.Html5.$6=function($p0){CourseSmartLocalStorage.Html5.$1.add($p0);}
CourseSmartLocalStorage.Html5.$7=function($p0){CourseSmartLocalStorage.Html5.$1.add($p0);}
CourseSmartLocalStorage.Html5.$8=function($p0){var $0=CourseSmartLocalStorage.Html5.get_$4();if($0>=$p0){return false;}BvD.LocalStorage.set('html5version',$p0.toString());return $0>-1;}
CourseSmartLocalStorage.Html5.$9=function(){var $enum1=ss.IEnumerator.getEnumerator(CourseSmartLocalStorage.Html5.$2);while($enum1.moveNext()){var $0=$enum1.current;try{$0();}catch($1){BvD.ClientSideError.send('HTML5.OfflineVersionUpdated',$1);}}}
CourseSmartLocalStorage.Html5.$A=function(){var $enum1=ss.IEnumerator.getEnumerator(CourseSmartLocalStorage.Html5.$1);while($enum1.moveNext()){var $0=$enum1.current;try{$0(CourseSmartLocalStorage.Html5.isOffline);}catch($1){BvD.ClientSideError.send('HTML5.OfflineFireEvent',$1);}}}
CourseSmartLocalStorage.Html5.$B=function($p0){try{var $0=CourseSmartLocalStorage.Html5.isOffline;CourseSmartLocalStorage.Html5.isOffline=false;if(!BvD.Is.NullOrUndefined(window.navigator)&&!BvD.Is.NullOrUndefined(window.navigator.onLine)&&!window.navigator.onLine){CourseSmartLocalStorage.Html5.isOffline=true;}if(!CourseSmartLocalStorage.Html5.$0){CourseSmartLocalStorage.Html5.isOffline=true;}if($p0){return CourseSmartLocalStorage.Html5.isOffline;}if($0!==CourseSmartLocalStorage.Html5.isOffline){CourseSmartLocalStorage.Html5.$A();}}catch($1){BvD.ClientSideError.send('HTML5.DoOfflineCheck',$1);}return CourseSmartLocalStorage.Html5.isOffline;}
CourseSmartLocalStorage.Html5.$C=function($p0){CourseSmartLocalStorage.Html5.$B(false);}
CourseSmartLocalStorage.LocalBook=function(){this.set_version(1);this.offline={};this.preference={};this.hits={};this.bookmarks={};this.notes=[];}
CourseSmartLocalStorage.LocalBook.create=function(data){var $0=new CourseSmartLocalStorage.LocalBook();$0.offline=data.offline;$0.preference=data.preference;$0.hits=data.hits;$0.bookmarks=data.bookmarks;$0.notes=data.notes;$0.expirationDate=data.expirationDate;$0.guid=data.guid;return $0;}
CourseSmartLocalStorage.LocalBook.prototype={version:0,get_version:function(){return this.version;},set_version:function(value){this.version=value;return value;},guid:null,get_guid:function(){return this.guid;},set_guid:function(value){this.guid=value;return value;},expirationDate:null,get_expirationDate:function(){return this.expirationDate;},set_expirationDate:function(value){this.expirationDate=value;return value;},get_isExpired:function(){if(BvD.Is.NullOrUndefined(this.expirationDate)){return true;}return new Date()>BvD.ServerDateTime.parse(this.expirationDate);},offline:null,get_versions:function(){return this.offline;},set_versions:function(value){this.offline=value;return value;},preference:null,get_preference:function(){return this.preference;},set_preference:function(value){this.preference=value;return value;},hits:null,get_hits:function(){return this.hits;},set_hits:function(value){this.hits=value;return value;},bookmarks:null,get_bookmarks:function(){return this.bookmarks;},set_bookmarks:function(value){this.bookmarks=value;return value;},notes:null,get_notes:function(){return this.notes;},set_notes:function(value){this.notes=value;return value;},addOrUpdateNote:function(note){var $0=note.xmlId.split('/');if($0.length!==2){return;}var $1=$0[0].toUpperCase();var $2=$0[1].toUpperCase();if(BvD.Is.NullOrUndefined(note.selection)){note.selection=null;}if(BvD.Is.NullOrUndefined(note.commentFormat)){note.commentFormat=0;}if(BvD.Is.NullOrUndefined(note.coordinate)){note.coordinate=null;}var $3=-1;var $4=null;var $enum1=ss.IEnumerator.getEnumerator(this.notes);while($enum1.moveNext()){var $6=$enum1.current;$3=Math.min($3,$6.id);if($6.id===note.id){$4=$6;break;}}if(note.isHighlightOnly){note.subject=null;note.content=null;}var $5=BvD.ServerDateTime.toString(new Date());if($4!=null){$4.subject=note.subject;$4.content=note.content;$4.commentformat=note.commentFormat;$4.date=$5;if($4.contentremoved&&!note.isHighlightOnly){$4.contentremoved=false;}}else{if(note.id===-1){note.id=$3-1;$4={};$4.id=note.id;$4.date=$5;$4.commentformat=note.commentFormat;$4.coord=note.coordinate;$4.selection=note.selection;$4.subject=note.subject;$4.content=note.content;$4.imagepage=note.imagePage;$4.page=$2;$4.fpid=$1;}else if(note.id>0){$4={};$4.id=note.id;$4.date=$5;$4.commentformat=note.commentFormat;$4.subject=note.subject;$4.content=note.content;}this.notes.add($4);}if(!BvD.Is.NullOrUndefined(note.removeHighlight)){if(!note.removeHighlight){$4.hlremoved=false;}else if(!note.isHighlightOnly){$4.hlremoved=true;}}if(!BvD.Is.NullOrUndefined(note.removeContent)){if(!note.removeContent){$4.contentremoved=false;}else if(!note.isHighlightOnly){$4.contentremoved=true;}}CourseSmartLocalStorage.CLocal$1.$5();},deleteNote:function(id){var $0=BvD.ServerDateTime.toString(new Date());var $1=false;var $enum1=ss.IEnumerator.getEnumerator(this.notes);while($enum1.moveNext()){var $2=$enum1.current;if($2.id!==id){continue;}if($2.id>0){$2.deleted=true;$2.date=$0;}else{this.notes.remove($2);}$1=true;break;}if(!$1&&id>0){var $3={};$3.id=id;$3.deleted=true;$3.date=$0;this.notes.add($3);}CourseSmartLocalStorage.CLocal$1.$5();},addBoomark:function(xmlId,readerMode){var $0=xmlId.split('/');if($0.length!==2){return;}var $1=$0[0].toUpperCase();var $2=$0[1].toUpperCase();if(BvD.Is.NullOrUndefined(readerMode)){readerMode=1;}var $3=this.bookmarks[$2];if($3==null){this.bookmarks[$2]={};this.bookmarks[$2].id=CourseSmartLocalStorage.OfflineCache.get_currentUser().set_$7(CourseSmartLocalStorage.OfflineCache.get_currentUser().get_$7()-1);this.bookmarks[$2].mode=readerMode;this.bookmarks[$2].date=BvD.ServerDateTime.toString(new Date());this.bookmarks[$2].xmlid=xmlId;}else{if($3.deleted||ss.isValue($3.deleted2)&&$3.deleted2===3){if($3.id>0){delete this.bookmarks[$2];}else{$3.deleted=false;if(ss.isValue($3.deleted2)){$3.deleted2&=~readerMode;}else{$3.deleted2=3&~readerMode;}$3.date=BvD.ServerDateTime.toString(new Date());}}else if(ss.isValue($3.deleted2)){$3.deleted2&=~readerMode;}if(ss.isValue($3.mode)){$3.mode|=readerMode;}else{$3.mode=1|readerMode;}}CourseSmartLocalStorage.CLocal$1.$5();},deleteBookmark:function(xmlId,id,readerMode){var $0=xmlId.split('/');if($0.length!==2){return;}var $1=$0[0].toUpperCase();var $2=$0[1].toUpperCase();if(BvD.Is.NullOrUndefined(readerMode)){readerMode=3;}var $3=BvD.ServerDateTime.toString(new Date());var $4=this.bookmarks[$2];if($4!=null&&id<=0){if(BvD.Is.NullOrUndefined($4.deleted2)){$4.deleted2=readerMode;}else{$4.deleted2|=readerMode;}if($4.deleted2===3||$4.deleted){delete this.bookmarks[$2];}}else if(id>0){if($4==null){this.bookmarks[$2]=$4={};}$4.date=$3;if($4.deleted){$4.deleted=false;$4.deleted2=3;}else if(BvD.Is.NullOrUndefined($4.deleted2)){$4.deleted2=readerMode;}else{$4.deleted2|=readerMode;}$4.id=id;}CourseSmartLocalStorage.CLocal$1.$5();},addHit:function(page){var $0=this.hits[page];if(BvD.Is.NullOrUndefined($0)){$0=0;}this.hits[page]=$0+1;CourseSmartLocalStorage.CLocal$1.$5();},setPreferences:function(obj){var $0=CourseSmartLocalStorage.OfflineCache.get_currentUser().get_preferences();var $dict1=obj;for(var $key2 in $dict1){var $1={key:$key2,value:$dict1[$key2]};if(!String.isNullOrEmpty($1.value)){continue;}switch($1.key){case 'flashparams':$0.flashparams=$1.value;$0.lastupdate=BvD.ServerDateTime.toString(new Date());break;case 'pfzoom':$0.pfzoom=$1.value;$0.lastupdate=BvD.ServerDateTime.toString(new Date());break;case 'htmlzoom':$0.htmlzoom=$1.value;$0.lastupdate=BvD.ServerDateTime.toString(new Date());break;case 'lastviewedpage':this.get_preference().lastviewedpage=$1.value;this.get_preference().lastupdate=BvD.ServerDateTime.toString(new Date());break;case 'lastviewedsection':this.get_preference().lastviewedsection=$1.value;this.get_preference().lastupdate=BvD.ServerDateTime.toString(new Date());break;}}CourseSmartLocalStorage.CLocal$1.$5();}}
CourseSmartLocalStorage.LocalData=function(){this.oldDeletedNotes=[];this.version=1;this.books={};this.preferences={};this.set_deviceGuid(null);}
CourseSmartLocalStorage.LocalData.create=function(data){var $0=new CourseSmartLocalStorage.LocalData();$0.version=data.version;$0.preferences=data.preferences;$0.deviceGuid=data.deviceGuid;$0.email=data.email;$0.lastSyncDate=data.lastSyncDate;$0.books={};var $dict1=data.books;for(var $key2 in $dict1){var $1={key:$key2,value:$dict1[$key2]};$0.books[$1.key]=CourseSmartLocalStorage.LocalBook.create($1.value);}return $0;}
CourseSmartLocalStorage.LocalData.prototype={version:0,get_version:function(){return this.version;},set_version:function(value){this.version=value;return value;},email:null,get_email:function(){return this.email;},set_email:function(value){this.email=value;return value;},deviceGuid:null,get_deviceGuid:function(){return this.deviceGuid;},set_deviceGuid:function(value){this.deviceGuid=value;return value;},lastSyncDate:null,get_lastSyncDate:function(){return this.lastSyncDate;},set_lastSyncDate:function(value){this.lastSyncDate=value;return value;},books:null,get_$0:function(){return this.books;},set_$0:function($p0){this.books=$p0;return $p0;},preferences:null,get_preferences:function(){return this.preferences;},set_preferences:function(value){this.preferences=value;return value;},getAllGuids:function(){var $0=[];$0.add('"DEVICE"');if(String.isNullOrEmpty(this.get_deviceGuid())){$0.add('null');}else{$0.add('"'+this.get_deviceGuid()+'"');}var $dict1=this.books;for(var $key2 in $dict1){var $1={key:$key2,value:$dict1[$key2]};if(String.isNullOrEmpty($1.value.get_guid())){continue;}$0.add('"'+$1.key+'"');$0.add('"'+$1.value.get_guid()+'"');}return '['+$0.join(',')+']';},hasOfflineBooks:function(){var $dict1=this.books;for(var $key2 in $dict1){var $0={key:$key2,value:$dict1[$key2]};if(!String.isNullOrEmpty($0.value.get_guid())){return true;}}return false;},hasBook:function(fpId){var $0=this.books[fpId.toUpperCase()];if(BvD.Is.NullOrUndefined($0)){return false;}return !BvD.Is.NullOrUndefined($0.get_guid());},$1:function(){this.lastSyncDate=BvD.ServerDateTime.get_nowUtcString();},$2:function($p0){if(String.isNullOrEmpty($p0)){return '[]';}$p0=BvD.JsonUtils.decompress($p0);var $0=$.parseJSON($p0);var $1=[];for(var $2=0;$2<$0.length;$2+=2){var $3=$0[$2];var $4=$0[$2+1];if(String.isNullOrEmpty($3)||String.isNullOrEmpty($4)){continue;}$1.add('"'+$3+'"');$1.add('"'+$4+'"');}return '['+$1.join(',')+']';},$3:function($p0){if(String.isNullOrEmpty($p0)){return;}$p0=BvD.JsonUtils.decompress($p0);var $0=$.parseJSON($p0);var $1=[];for(var $2=0;$2<$0.length;$2+=2){var $3=$0[$2].toUpperCase();var $4=$0[$2+1];var $5=this.get_$0()[$3];$1.add($4);if($3==='DEVICE'){this.set_deviceGuid($4);}else if(BvD.Is.NullOrUndefined($5)){$5=new CourseSmartLocalStorage.LocalBook();$5.set_guid($4);this.get_$0()[$3]=$5;}else{this.get_$0()[$3].set_guid($4);}}var $dict1=this.get_$0();for(var $key2 in $dict1){var $6={key:$key2,value:$dict1[$key2]};if(!$1.contains($6.value.get_guid())){$6.value.set_guid(null);}}CourseSmartLocalStorage.OfflineCache.$5();},$4:function($p0){if(String.isNullOrEmpty($p0)){return;}$p0=BvD.JsonUtils.decompress($p0);var $0=$.parseJSON($p0);for(var $2=0;$2<$0.length;$2+=2){var $3=$0[$2].toUpperCase();var $4=this.get_$0()[$3];if(BvD.Is.NullOrUndefined($4)){$4=new CourseSmartLocalStorage.LocalBook();this.get_$0()[$3]=$4;}$4.set_expirationDate($0[$2+1]);}var $1=[];var $dict1=this.get_$0();for(var $key2 in $dict1){var $5={key:$key2,value:$dict1[$key2]};var $6=$5.key;var $7=false;for(var $8=0;!$7&&$8<$0.length;$8+=2){var $9=$0[$8];$7=String.equals($6,$9,true);}if(!$7){$1.add($6);}}var $enum3=ss.IEnumerator.getEnumerator($1);while($enum3.moveNext()){var $A=$enum3.current;var $B=this.get_$0()[$A];if(!BvD.Is.NullOrUndefined($B)){$B.set_expirationDate(null);}}},$5:function($p0){if(String.isNullOrEmpty($p0)){return;}$p0=BvD.JsonUtils.decompress($p0);var $0=$.parseJSON($p0);for(var $1=0;$1<$0.length;$1++){var $2=($0[$1][0]).toUpperCase();var $3=this.get_$0()[$2];if(BvD.Is.NullOrUndefined($3)){$3=new CourseSmartLocalStorage.LocalBook();this.get_$0()[$2]=$3;}$3.get_versions().notes=$0[$1][1];$3.get_versions().highlight=$0[$1][2];$3.get_versions().searches=$0[$1][3];$3.get_versions().pages=$0[$1][4];if($0[$1].length>5){$3.get_versions().bookmarks=$0[$1][5];}else{$3.get_versions().bookmarks=0;}if($0[$1].length>6){$3.get_versions().preferences=$0[$1][6];}else{$3.get_versions().preferences=0;}if($0[$1].length>7){$3.get_versions().htmlthumb=$0[$1][7];}else{$3.get_versions().htmlthumb=0;}if($0[$1].length>8){$3.get_versions().epubsearches=$0[$1][8];}else{$3.get_versions().epubsearches=0;}}},$6:0,get_$7:function(){if(!this.$6){var $dict1=this.books;for(var $key2 in $dict1){var $0={key:$key2,value:$dict1[$key2]};var $dict3=$0.value.get_bookmarks();for(var $key4 in $dict3){var $1={key:$key4,value:$dict3[$key4]};this.$6=Math.min(this.$6,$1.value.id);}}if(isNaN(this.$6)){this.$6=-2;}else{this.$6=Math.min(this.$6,-2);}}return this.$6;},set_$7:function($p0){this.$6=$p0;return $p0;},get_item:function(fpId){var $0=this.books[fpId.toUpperCase()];if(BvD.Is.NullOrUndefined($0)){return new CourseSmartLocalStorage.LocalBook();}return $0;}}
CourseSmartLocalStorage.CLocal$1=function(){}
CourseSmartLocalStorage.CLocal$1.$3=function(){try{if(CourseSmartLocalStorage.CLocal$1.$2==null){CourseSmartLocalStorage.CLocal$1.$2=CourseSmartLocalStorage.CLocal$1.$6(CourseSmartLocalStorage.CLocal$1.$0);var $0=CourseSmartLocalStorage.CLocal$1.$7(CourseSmartLocalStorage.CLocal$1.$1);if($0!=null){var $dict1=$0;for(var $key2 in $dict1){var $1={key:$key2,value:$dict1[$key2]};if(!Object.keyExists(CourseSmartLocalStorage.CLocal$1.$2,$1.key)){CourseSmartLocalStorage.CLocal$1.$2[$1.key]=$1.value;}else{var $dict3=$1.value.get_$0();for(var $key4 in $dict3){var $2={key:$key4,value:$dict3[$key4]};if(CourseSmartLocalStorage.CLocal$1.$2[$1.key].hasBook($2.key)){continue;}CourseSmartLocalStorage.CLocal$1.$2[$1.key].get_$0()[$2.key]=$2.value;}CourseSmartLocalStorage.CLocal$1.$2[$1.key].oldDeletedNotes=$1.value.oldDeletedNotes;}}}}return CourseSmartLocalStorage.CLocal$1.$2;}catch($3){BvD.ClientSideError.send('Error in loading localstorage: '+BvD.LocalStorage.get(CourseSmartLocalStorage.CLocal$1.$0)+'\r\n'+BvD.LocalStorage.get(CourseSmartLocalStorage.CLocal$1.$1),$3);return null;}}
CourseSmartLocalStorage.CLocal$1.$4=function($p0){var $0=CourseSmartLocalStorage.CLocal$1.$3();var $1;$0[$p0.toString()]=$1=new CourseSmartLocalStorage.LocalData();return $1;}
CourseSmartLocalStorage.CLocal$1.$5=function(){if(CourseSmartLocalStorage.CLocal$1.$2!=null){var $0=CourseSmartLocalStorage.CLocal$1.$A(0);var $1=CourseSmartLocalStorage.CLocal$1.$A(1);BvD.LocalStorage.set(CourseSmartLocalStorage.CLocal$1.$0,JSON.stringify($1));if($0!=null){BvD.LocalStorage.set(CourseSmartLocalStorage.CLocal$1.$1,CourseSmartLocalStorage.CLocal$1.$9($0));}}}
CourseSmartLocalStorage.CLocal$1.$6=function($p0){var $0;var $1=BvD.LocalStorage.get($p0);if(BvD.Is.NullOrUndefined($1)||String.isNullOrEmpty($1)){return {};}$1=BvD.JsonUtils.decompress($1);var $2=$.parseJSON($1);$0={};var $dict1=$2;for(var $key2 in $dict1){var $3={key:$key2,value:$dict1[$key2]};$0[$3.key]=CourseSmartLocalStorage.LocalData.create($3.value);}return $0;}
CourseSmartLocalStorage.CLocal$1.$7=function($p0){var $0=BvD.LocalStorage.get($p0);if(BvD.Is.NullOrUndefined($0)||String.isNullOrEmpty($0)){return null;}var $1;try{$1=CourseSmartLocalStorage.CLocal$1.$6($p0);if($1!=null&&Object.getKeyCount($1)>0&&!BvD.Is.NullOrUndefined($1[Object.keys($1)[0]].get_version())){return $1;}}catch($2){}$1=eval('('+$0+')');$1=CourseSmartLocalStorage.CLocal$1.$8($1);return $1;}
CourseSmartLocalStorage.CLocal$1.$8=function($p0){var $0={};var $1=$p0;var $dict1=$1;for(var $key2 in $dict1){var $2={key:$key2,value:$dict1[$key2]};var $3=$2.value;var $4=new CourseSmartLocalStorage.LocalData();$0[$2.key]=$4;var $5=eval('('+($3['books']||'{}')+')');var $6=BvD.JsonUtils.decompress(($3['preferences']||'{}').replaceAll('\\"','"'));$4.set_version(0);$4.set_email($5['email']);$4.$3($5['guid']);$4.$4($5['swapdates']);$4.set_lastSyncDate($5['LastSyncDate']);var $dict3=$4.get_$0();for(var $key4 in $dict3){var $A={key:$key4,value:$dict3[$key4]};$A.value.set_version(0);}if(!String.isNullOrEmpty($6)){var $B=eval('('+$6+')');var $enum5=ss.IEnumerator.getEnumerator(Object.keys($B));while($enum5.moveNext()){var $C=$enum5.current;if($C==='general'){$4.set_preferences($B[$C]);}else if(!BvD.Is.NullOrUndefined($4.get_item($C))){$4.get_item($C).set_preference($B[$C]);}}}if(!BvD.Is.NullOrUndefined($5['offline'])){var $D=$5['offline'];var $enum6=ss.IEnumerator.getEnumerator(Object.keys($D));while($enum6.moveNext()){var $E=$enum6.current;if(!BvD.Is.NullOrUndefined($4.get_item($E))){$4.get_item($E).set_versions($D[$E]);}}}var $7=BvD.JsonUtils.decompress(($3['hits']||'').replaceAll('\\"','"'));if(!String.isNullOrEmpty($7)){var $F=eval('('+$7+')');var $enum7=ss.IEnumerator.getEnumerator(Object.keys($F));while($enum7.moveNext()){var $10=$enum7.current;if(!BvD.Is.NullOrUndefined($4.get_item($10))){$4.get_item($10).set_hits($F[$10]);}}}var $8=BvD.JsonUtils.decompress(($3['bookmarks']||'').replaceAll('\\"','"'));if(!String.isNullOrEmpty($8)){var $11=eval('('+$8+')');var $enum8=ss.IEnumerator.getEnumerator(Object.keys($11));while($enum8.moveNext()){var $12=$enum8.current;if(!BvD.Is.NullOrUndefined($4.get_item($12))){$4.get_item($12).set_bookmarks($11[$12]);}}}var $9=$3['notes']||'';if(!String.isNullOrEmpty($9)){var $13=eval('('+$9+')');var $enum9=ss.IEnumerator.getEnumerator($13);while($enum9.moveNext()){var $14=$enum9.current;if(BvD.Is.NullOrUndefined($14.fpid)){$4.oldDeletedNotes.add($14);}else if(!BvD.Is.NullOrUndefined($4.get_item($14.fpid))){$4.get_item($14.fpid).get_notes().add($14);}}}}return $0;}
CourseSmartLocalStorage.CLocal$1.$9=function($p0){var $0={};var $dict1=$p0;for(var $key2 in $dict1){var $1={key:$key2,value:$dict1[$key2]};$0[$1.key]={};var $2={};var $3=[];var $4=[];var $5={};var $6={};var $7={};var $8=[];var $9={};$3.add('DEVICE');$3.add($1.value.get_deviceGuid());$7['general']={};$7['general']['flashparams']=$1.value.get_preferences().flashparams;$7['general']['htmlzoom']=$1.value.get_preferences().htmlzoom;$7['general']['lastupdate']=$1.value.get_preferences().lastupdate;$7['general']['pfzoom']=$1.value.get_preferences().pfzoom;var $enum3=ss.IEnumerator.getEnumerator($1.value.oldDeletedNotes);while($enum3.moveNext()){var $A=$enum3.current;var $B={};$B['date']=$A.date;$B['commentformat']=$A.commentformat;$B['coord']=$A.coord;$B['selection']=$A.selection;$B['subject']=$A.subject;$B['content']=$A.content;$B['imagepage']=$A.imagepage;$B['id']=$A.id;$B['page']=$A.page;$B['fpid']=$A.fpid;if($A.contentremoved){$B['contentremoved']=$A.contentremoved;}if($A.deleted){$B['deleted']=$A.deleted;}if($A.hlremoved){$B['hlremoved']=$A.hlremoved;}$8.add($B);}var $dict4=$1.value.get_$0();for(var $key5 in $dict4){var $C={key:$key5,value:$dict4[$key5]};$3.add($C.key);$3.add($C.value.get_guid());$4.add($C.key);$4.add($C.value.get_expirationDate());$5[$C.key]={};$5[$C.key]['notes']=$C.value.get_versions().notes;$5[$C.key]['highlights']=$C.value.get_versions().highlight;$5[$C.key]['searches']=$C.value.get_versions().searches;$5[$C.key]['pages']=$C.value.get_versions().pages;$5[$C.key]['bookmarks']=$C.value.get_versions().bookmarks;$5[$C.key]['preferences']=$C.value.get_versions().preferences;$5[$C.key]['htmlthumb']=$C.value.get_versions().htmlthumb;$5[$C.key]['epubsearches']=$C.value.get_versions().epubsearches;$6[$C.key]=$C.value.get_hits();$7[$C.key]={};$7[$C.key]['lastupdate']=$C.value.get_preference().lastupdate;$7[$C.key]['lastviewedsection']=$C.value.get_preference().lastviewedsection;$7[$C.key]['lastviewedpage']=$C.value.get_preference().lastviewedpage;var $enum6=ss.IEnumerator.getEnumerator($C.value.get_notes());while($enum6.moveNext()){var $E=$enum6.current;var $F={};$F['date']=$E.date;$F['commentformat']=$E.commentformat;$F['coord']=$E.coord;$F['selection']=$E.selection;$F['subject']=$E.subject;$F['content']=$E.content;$F['imagepage']=$E.imagepage;$F['id']=$E.id;$F['page']=$E.page;$F['fpid']=$E.fpid;if($E.contentremoved){$F['contentremoved']=$E.contentremoved;}if($E.deleted){$F['deleted']=$E.deleted;}if($E.hlremoved){$F['hlremoved']=$E.hlremoved;}$8.add($F);}var $D={};$9[$C.key]=$D;var $dict7=$C.value.get_bookmarks();for(var $key8 in $dict7){var $10={key:$key8,value:$dict7[$key8]};$D[$10.key]={};$D[$10.key]['id']=$10.value.id;$D[$10.key]['mode']=$10.value.mode;$D[$10.key]['date']=$10.value.date;$D[$10.key]['xmlid']=$10.value.xmlid;if($10.value.deleted){$D[$10.key]['deleted']=$10.value.deleted;}if($10.value.deleted2!=null){$D[$10.key]['deleted2']=$10.value.deleted2;}}}$2['guid']=JSON.stringify($3);$2['offline']=$5;$2['email']=$1.value.get_email();$2['swapdates']=JSON.stringify($4);$0[$1.key]['books']=JSON.stringify($2);$0[$1.key]['hits']=JSON.stringify($6);$0[$1.key]['preferences']=JSON.stringify($7);$0[$1.key]['notes']=JSON.stringify($8);$0[$1.key]['bookmarks']=JSON.stringify($9);}return JSON.stringify($0);}
CourseSmartLocalStorage.CLocal$1.$A=function($p0){var $0={};var $1=0;var $dict1=CourseSmartLocalStorage.CLocal$1.$2;for(var $key2 in $dict1){var $2={key:$key2,value:$dict1[$key2]};$0[$2.key]=new CourseSmartLocalStorage.LocalData();$0[$2.key].set_deviceGuid($2.value.get_deviceGuid());$0[$2.key].set_email($2.value.get_email());$0[$2.key].set_$7($2.value.get_$7());$0[$2.key].set_lastSyncDate($2.value.get_lastSyncDate());$0[$2.key].set_preferences($2.value.get_preferences());$0[$2.key].set_version($2.value.get_version());if(!$p0){$0[$2.key].oldDeletedNotes=$2.value.oldDeletedNotes;}var $dict3=$2.value.get_$0();for(var $key4 in $dict3){var $3={key:$key4,value:$dict3[$key4]};if($3.value.get_version()===$p0){$0[$2.key].get_$0()[$3.key]=$3.value;}}$1+=Object.getKeyCount($0[$2.key].get_$0());}if(!$p0&&!$1){return null;}return $0;}
CourseSmartLocalStorage.CLocal$0=function(){}
CourseSmartLocalStorage.CLocal$0.get_$3=function(){return CourseSmartLocalStorage.CLocal$0.$1;}
CourseSmartLocalStorage.CLocal$0.get_$4=function(){return CourseSmartLocalStorage.CLocal$0.$2;}
CourseSmartLocalStorage.CLocal$0.$5=function(){try{CourseSmartLocalStorage.CLocal$0.$1=window.applicationCache.status;}catch($0){}try{window.applicationCache.addEventListener('cached',CourseSmartLocalStorage.CLocal$0.$7,false);window.applicationCache.addEventListener('checking',CourseSmartLocalStorage.CLocal$0.$7,false);window.applicationCache.addEventListener('downloading',CourseSmartLocalStorage.CLocal$0.$7,false);window.applicationCache.addEventListener('error',CourseSmartLocalStorage.CLocal$0.$7,false);window.applicationCache.addEventListener('noupdate',CourseSmartLocalStorage.CLocal$0.$7,false);window.applicationCache.addEventListener('progress',CourseSmartLocalStorage.CLocal$0.$7,false);window.applicationCache.addEventListener('updateready',CourseSmartLocalStorage.CLocal$0.$7,false);}catch($1){}}
CourseSmartLocalStorage.CLocal$0.$6=function($p0){CourseSmartLocalStorage.CLocal$0.$0.add($p0);}
CourseSmartLocalStorage.CLocal$0.$7=function($p0){CourseSmartLocalStorage.CLocal$0.$1=window.applicationCache.status;CourseSmartLocalStorage.CLocal$0.$2=$p0.type==='downloading'||$p0.type==='progress';if($p0.type==='updateready'){try{window.applicationCache.swapCache();}catch($0){}}CourseSmartLocalStorage.CLocal$0.$8($p0);}
CourseSmartLocalStorage.CLocal$0.$8=function($p0){var $enum1=ss.IEnumerator.getEnumerator(CourseSmartLocalStorage.CLocal$0.$0);while($enum1.moveNext()){var $0=$enum1.current;try{$0($p0);}catch($1){BvD.ClientSideError.send('Manifest.FireCacheEvent',$1);}}}
CourseSmartLocalStorage.OfflineCache=function(){}
CourseSmartLocalStorage.OfflineCache.init=function(){CourseSmartLocalStorage.Html5.$3();CourseSmartLocalStorage.OfflineCache.$6(null);CourseSmartLocalStorage.OfflineCache.$4();CourseSmartLocalStorage.OfflineCache.$5();CourseSmartLocalStorage.Synchronization.init(false);var $0=BvD.Xsl.get_currentPage();if($0!=='/offlinebookshelf'&&!CourseSmartLocalStorage.OfflineCache.$1.contains($0)){return;}if(CourseSmartLocalStorage.OfflineCache.get_currentUser()==null||!CourseSmartLocalStorage.OfflineCache.get_currentUser().hasOfflineBooks()){return;}CourseSmartLocalStorage.OfflineCache.$8(CourseSmartLocalStorage.Html5.isOffline);CourseSmartLocalStorage.Html5.$6(CourseSmartLocalStorage.OfflineCache.$8);if($0!=='/offlinebookshelf'){BvD.Timer.setTimeout('cs_offline_redirect',3000,CourseSmartLocalStorage.OfflineCache.$7);BvD.Timer.setInterval('cs_check_connection',500,CourseSmartLocalStorage.Html5.$5);}}
CourseSmartLocalStorage.OfflineCache.get_currentUser=function(){return CourseSmartLocalStorage.OfflineCache.$0;}
CourseSmartLocalStorage.OfflineCache.alreadyUsedByOtherUser=function(){var $0=CourseSmartLocalStorage.CLocal$1.$3();if($0==null){return false;}var $dict1=$0;for(var $key2 in $dict1){var $1={key:$key2,value:$dict1[$key2]};if($1.key===BvD.Xsl.get_userId().toString()||$1.value==null||$1.value.get_deviceGuid()==null){continue;}var $dict3=$1.value.get_$0();for(var $key4 in $dict3){var $2={key:$key4,value:$dict3[$key4]};if(!String.isNullOrEmpty($2.value.get_guid())){return true;}}}return false;}
CourseSmartLocalStorage.OfflineCache.isCheckedOutEmail=function(email){return CourseSmartLocalStorage.OfflineCache.$6(email)!=null;}
CourseSmartLocalStorage.OfflineCache.getNotes=function(fpId){if(!CourseSmartLocalStorage.OfflineCache.get_currentUser().hasBook(fpId)){return null;}var $0=new BvD.QueryString().set('__className','smartreaderofflinenotes').set('userid',BvD.Xsl.get_userId().toString()).set('offline',CourseSmartLocalStorage.OfflineCache.get_currentUser().get_item(fpId).get_versions().notes.toString()).set('xmlid',fpId.toUpperCase());return CourseSmartLocalStorage.OfflineCache.$2('/blank?'+$0.toString(),'NotesJSon')||'{}';}
CourseSmartLocalStorage.OfflineCache.getSharingNoteUsers=function(fpId){if(!CourseSmartLocalStorage.OfflineCache.get_currentUser().hasBook(fpId)){return null;}var $0=new BvD.QueryString().set('__className','smartreaderofflinenotes').set('userid',BvD.Xsl.get_userId().toString()).set('offline',CourseSmartLocalStorage.OfflineCache.get_currentUser().get_item(fpId).get_versions().notes.toString()).set('xmlid',fpId.toUpperCase());return CourseSmartLocalStorage.OfflineCache.$2('/blank?'+$0.toString(),'SharingNoteUsers')||'{}';}
CourseSmartLocalStorage.OfflineCache.getPreferences=function(fpId){if(!CourseSmartLocalStorage.OfflineCache.get_currentUser().hasBook(fpId)){return null;}var $0=new BvD.QueryString().set('__className','smartreaderofflinepreferences').set('userid',BvD.Xsl.get_userId().toString()).set('offline',CourseSmartLocalStorage.OfflineCache.get_currentUser().get_item(fpId).get_versions().preferences.toString()).set('xmlid',fpId.toUpperCase());var $1=CourseSmartLocalStorage.OfflineCache.$2('/blank?'+$0.toString(),'OfflinePreferences')||'{}';try{return $.parseJSON($1);}catch($2){return eval('('+$1+')');}}
CourseSmartLocalStorage.OfflineCache.getBookmarks=function(fpId){if(!CourseSmartLocalStorage.OfflineCache.get_currentUser().hasBook(fpId)){return null;}var $0=new BvD.QueryString().set('__className','smartreaderofflinebookmarks').set('userid',BvD.Xsl.get_userId().toString()).set('offline',CourseSmartLocalStorage.OfflineCache.get_currentUser().get_item(fpId).get_versions().bookmarks.toString()).set('xmlid',fpId.toUpperCase());return CourseSmartLocalStorage.OfflineCache.$2('/blank?'+$0.toString(),'BookmarksJSon')||'{}';}
CourseSmartLocalStorage.OfflineCache.getPagesList=function(fpId){if(!CourseSmartLocalStorage.OfflineCache.get_currentUser().hasBook(fpId)){return null;}var $0=new BvD.QueryString().set('__className','smartreaderavailableofflinetoc').set('userid',BvD.Xsl.get_userId().toString()).set('offline',CourseSmartLocalStorage.OfflineCache.get_currentUser().get_item(fpId).get_versions().pages.toString()).set('xmlid',fpId.toUpperCase());var $1=CourseSmartLocalStorage.OfflineCache.$2('/blank?'+$0.toString(),'OfflineTocJSon')||'[]';try{return $.parseJSON($1);}catch($2){return eval('('+$1+')');}}
CourseSmartLocalStorage.OfflineCache.getSearches=function(fpId){if(!CourseSmartLocalStorage.OfflineCache.get_currentUser().hasBook(fpId)){return null;}var $0=new BvD.QueryString().set('userid',BvD.Xsl.get_userId().toString()).set('offline',CourseSmartLocalStorage.OfflineCache.get_currentUser().get_item(fpId).get_versions().searches.toString()).set('xmlid',fpId.toUpperCase());var $1=CourseSmartLocalStorage.OfflineCache.$3('/bookreadersearchesoffline?'+$0.toString())||'{}';try{return $.parseJSON($1);}catch($2){return eval('('+$1+')');}}
CourseSmartLocalStorage.OfflineCache.getEPubIndex=function(fpId){if(!CourseSmartLocalStorage.OfflineCache.get_currentUser().hasBook(fpId)){return null;}var $0=new BvD.QueryString().set('userid',BvD.Xsl.get_userId().toString()).set('offline',CourseSmartLocalStorage.OfflineCache.get_currentUser().get_item(fpId).get_versions().epubsearches.toString()).set('xmlid',fpId.toUpperCase());var $1=CourseSmartLocalStorage.OfflineCache.$3('/offlineepubsearchidx?'+$0.toString())||'{}';try{return $.parseJSON($1);}catch($2){return eval('('+$1+')');}}
CourseSmartLocalStorage.OfflineCache.$2=function($p0,$p1){var $0=null;var $1={};$1.async=false;$1.success=function($p1_0,$p1_1,$p1_2){
if(BvD.Is.NullOrUndefined($p1_0)){return;}var $1_0=$p1_0;var $1_1=$1_0.getElementsByTagName($p1);if($1_1!=null&&$1_1.length>0){$0=$1_1[0].innerHTML||BvD.Utils.getWholeXmlNodeContent($1_1[0]);}};$.ajax($p0,$1);return $0;}
CourseSmartLocalStorage.OfflineCache.$3=function($p0){var $0=null;var $1={};$1.async=false;$1.success=function($p1_0,$p1_1,$p1_2){
if(BvD.Is.NullOrUndefined($p1_0)){return;}$0=$p1_0;};$.ajax($p0,$1);return $0;}
CourseSmartLocalStorage.OfflineCache.$4=function(){if(BvD.Xsl.get_currentPage()!=='/offlinebookshelf'&&BvD.Xsl.get_currentPage()!=='/bookreader'){return;}if(CourseSmartLocalStorage.Html5.isOffline){BvD.Cookies.set_isReadOnly(true);}else{var $0=BvD.Xsl.get_userId();var $1=BvD.Cookies.getStateValueParameter('usercheckedoutid');if(String.isNullOrEmpty($1)&&$0>0&&CourseSmartLocalStorage.OfflineCache.get_currentUser().hasOfflineBooks()){BvD.Cookies.setStateValueParameter('usercheckedoutid',$0.toString());}}}
CourseSmartLocalStorage.OfflineCache.$5=function(){if(BvD.Xsl.get_isLogged()&&CourseSmartLocalStorage.OfflineCache.get_currentUser()!=null&&CourseSmartLocalStorage.OfflineCache.get_currentUser().get_deviceGuid()!=null){BvD.Cookies.setStateValueParameter('offlinedeviceguid',BvD.Xsl.get_userId()+'|'+CourseSmartLocalStorage.OfflineCache.get_currentUser().get_deviceGuid());}else{BvD.Cookies.setStateValueParameter('offlinedeviceguid','');}}
CourseSmartLocalStorage.OfflineCache.$6=function($p0){var $0=CourseSmartLocalStorage.CLocal$1.$3();if(BvD.Is.NullOrUndefined($0)){return CourseSmartLocalStorage.OfflineCache.$0;}if(BvD.Xsl.get_isLogged()&&Object.keyExists($0,BvD.Xsl.get_userId().toString())){CourseSmartLocalStorage.OfflineCache.$0=$0[BvD.Xsl.get_userId().toString()];if(!String.isNullOrEmpty($p0)&&CourseSmartLocalStorage.OfflineCache.$0.get_email()===$p0){return CourseSmartLocalStorage.OfflineCache.$0;}else if(!String.isNullOrEmpty($p0)){CourseSmartLocalStorage.OfflineCache.$0=new CourseSmartLocalStorage.LocalData();}}else if(BvD.Xsl.get_isLogged()&&!Object.keyExists($0,BvD.Xsl.get_userId().toString())){CourseSmartLocalStorage.OfflineCache.$0=CourseSmartLocalStorage.CLocal$1.$4(BvD.Xsl.get_userId());}else if(!String.isNullOrEmpty($p0)){var $dict1=$0;for(var $key2 in $dict1){var $1={key:$key2,value:$dict1[$key2]};if(Object.getKeyCount($1.value.get_$0())>0){CourseSmartLocalStorage.OfflineCache.$0=$1.value;break;}}}return CourseSmartLocalStorage.OfflineCache.$0;}
CourseSmartLocalStorage.OfflineCache.$7=function(){BvD.Timer.stop('cs_offline_redirect');BvD.Timer.stop('cs_check_connection');if(CourseSmartLocalStorage.Html5.isOffline){window.location.href='/offlinebookshelf';}}
CourseSmartLocalStorage.OfflineCache.$8=function($p0){if(BvD.Xsl.get_currentPage()!=='/offlinebookshelf'){return;}$('#OnlineBookShelfText').css('display',($p0)?'none':'inline');$('#BackToOnlineBookShelf, #currentlyOnlineLabel').css('display',($p0)?'none':'block');$('#currentlyOfflineLabel').css('display',($p0)?'block':'none');}
CourseSmartLocalStorage.CLocal$2.registerClass('CourseSmartLocalStorage.CLocal$2',BvD.Layer);CourseSmartLocalStorage.Synchronization.registerClass('CourseSmartLocalStorage.Synchronization');CourseSmartLocalStorage.OfflineDownloader.registerClass('CourseSmartLocalStorage.OfflineDownloader');CourseSmartLocalStorage.Html5.registerClass('CourseSmartLocalStorage.Html5');CourseSmartLocalStorage.LocalBook.registerClass('CourseSmartLocalStorage.LocalBook');CourseSmartLocalStorage.LocalData.registerClass('CourseSmartLocalStorage.LocalData');CourseSmartLocalStorage.CLocal$1.registerClass('CourseSmartLocalStorage.CLocal$1');CourseSmartLocalStorage.CLocal$0.registerClass('CourseSmartLocalStorage.CLocal$0');CourseSmartLocalStorage.OfflineCache.registerClass('CourseSmartLocalStorage.OfflineCache');CourseSmartLocalStorage.OfflineDownloader.$0=false;CourseSmartLocalStorage.OfflineDownloader.$1=0;CourseSmartLocalStorage.OfflineDownloader.$2=null;CourseSmartLocalStorage.OfflineDownloader.$3=false;CourseSmartLocalStorage.OfflineDownloader.$4=false;CourseSmartLocalStorage.Html5.$0=true;CourseSmartLocalStorage.Html5.$1=[];CourseSmartLocalStorage.Html5.$2=[];CourseSmartLocalStorage.Html5.isOffline=false;CourseSmartLocalStorage.CLocal$1.$0='coursesmartreader';CourseSmartLocalStorage.CLocal$1.$1='html5datas';CourseSmartLocalStorage.CLocal$1.$2=null;CourseSmartLocalStorage.CLocal$0.$0=[];CourseSmartLocalStorage.CLocal$0.$1=0;CourseSmartLocalStorage.CLocal$0.$2=false;CourseSmartLocalStorage.OfflineCache.$0=null;CourseSmartLocalStorage.OfflineCache.$1=['/','/home','/bookshelf'];})(jQuery);// This script was generated using Script# v0.7.4.0
